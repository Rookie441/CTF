## Format String Theory

[fst](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Easy/format-string-theory/fst)  
[fst.c](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Easy/format-string-theory/fst.c)  

> Let's analyze the get_title() function

```C
void get_title() {
    int *perm = &permission;
    FILE *fp;
    fp = fopen(filename, "a");    // Open my file of secrets

    if (fp == NULL)
        filegone();

    char *input;
    input = get_user_input();     // Get user input safely

    char result[64] = "";
    char prefix_format[8] = "%s";
    char prefix[8] = "--> ";

    strcat(result, prefix_format);
    strcat(result, input);

    fprintf(fp, result, prefix);
    fclose(fp);

    if (*perm)
        check_log();
}
```

> There is a format string vulnerability in the code. The fprintf() function call in the code uses a format string as the first argument and prefix as the second argument. The prefix is defined as a string with a value of "--> ", and it is concatenated with the user input using the strcat() function.

> The problem is that the format string passed to fprintf() is not properly formatted. It uses %s as the format specifier, but it does not have a corresponding argument in the argument list. This can allow an attacker to craft input that includes format specifiers, such as %n, which can be used to [write arbitrary data to memory](https://axcheron.github.io/exploit-101-format-strings/#writing-to-the-stack).

> In our case, we want to write to the value of `perm` so that we can run the check_log() function that prints our flag.

> The following is the stack layout:

```
prefix[8]
prefix_format[8]
char result[64] char *input (8 bytes) << Writing into here
FILE *fp (?? bytes)
int *perm (8 bytes â€“ This is an address)
rbp (8 bytes)
return address (8 bytes)
```

> Note that we cannot overwrite the file pointer as it would result in file not found. Hence we need to skip over the file pointer and write into the `int *perm`.
We can skip by doing `%[num]$n`, where [num] is the number of arguments that we want to skip over. As I do not know the size of the FILE *fp pointer, I tried several different values and `%6$n` worked:

![image](https://github.com/Rookie441/CTF/blob/main/Categories/Binary%20Exploitation/Easy/format-string-theory/Solved.png)  

`CS2107{How_A6oUt_f0rm@7_qU4nTum_tHE0rY}`
